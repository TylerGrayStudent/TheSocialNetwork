<mxfile host="app.diagrams.net" modified="2021-11-09T19:14:04.761Z" agent="5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.69 Safari/537.36" etag="l66w_nFE8xsZ-_qCUSkm" version="15.6.6" type="github">
  <diagram id="qRd6eIhB8OMw0SJ-CpMm" name="Page-1">
    <mxGraphModel dx="1214" dy="1849" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="850" pageHeight="1100" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="PNWq4bw_2nv1dbnlcLtl-1" value="Web Services&lt;br&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="60" y="190" width="140" height="80" as="geometry" />
        </mxCell>
        <mxCell id="PNWq4bw_2nv1dbnlcLtl-2" value="Azure&lt;br&gt;3 Tenants:&amp;nbsp;&lt;br&gt;Client&lt;br&gt;Employee&lt;br&gt;Franchise" style="ellipse;shape=cloud;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="340" y="-80" width="330" height="180" as="geometry" />
        </mxCell>
        <mxCell id="PNWq4bw_2nv1dbnlcLtl-5" value="" style="group" parent="1" vertex="1" connectable="0">
          <mxGeometry x="20" y="10" width="190" height="120" as="geometry" />
        </mxCell>
        <mxCell id="PNWq4bw_2nv1dbnlcLtl-4" value="" style="ellipse;shape=cloud;whiteSpace=wrap;html=1;" parent="PNWq4bw_2nv1dbnlcLtl-5" vertex="1">
          <mxGeometry width="190" height="120" as="geometry" />
        </mxCell>
        <mxCell id="PNWq4bw_2nv1dbnlcLtl-3" value="Trojan&lt;br&gt;" style="shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=15;" parent="PNWq4bw_2nv1dbnlcLtl-5" vertex="1">
          <mxGeometry x="65" y="20" width="60" height="80" as="geometry" />
        </mxCell>
        <mxCell id="PNWq4bw_2nv1dbnlcLtl-6" value="" style="endArrow=classic;html=1;rounded=0;entryX=0.55;entryY=0.95;entryDx=0;entryDy=0;entryPerimeter=0;" parent="1" target="PNWq4bw_2nv1dbnlcLtl-4" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="120" y="190" as="sourcePoint" />
            <mxPoint x="170" y="140" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="PNWq4bw_2nv1dbnlcLtl-13" value="" style="endArrow=classic;startArrow=classic;html=1;rounded=0;exitX=0.25;exitY=0;exitDx=0;exitDy=0;entryX=0.318;entryY=0.839;entryDx=0;entryDy=0;entryPerimeter=0;" parent="1" source="PNWq4bw_2nv1dbnlcLtl-11" target="PNWq4bw_2nv1dbnlcLtl-2" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="480" y="220" as="sourcePoint" />
            <mxPoint x="530" y="170" as="targetPoint" />
            <Array as="points">
              <mxPoint x="450" y="180" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="PNWq4bw_2nv1dbnlcLtl-17" value="" style="endArrow=classic;startArrow=classic;html=1;rounded=0;exitX=0.363;exitY=0.125;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="PNWq4bw_2nv1dbnlcLtl-15" target="PNWq4bw_2nv1dbnlcLtl-2" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="410" y="390" as="sourcePoint" />
            <mxPoint x="460" y="340" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="PNWq4bw_2nv1dbnlcLtl-19" value="3.1. IDP AuthNs with Web Services" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="210" y="190" width="100" height="40" as="geometry" />
        </mxCell>
        <mxCell id="PNWq4bw_2nv1dbnlcLtl-20" value="" style="endArrow=classic;startArrow=classic;html=1;rounded=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="PNWq4bw_2nv1dbnlcLtl-1" target="PNWq4bw_2nv1dbnlcLtl-11" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="220" y="260" as="sourcePoint" />
            <mxPoint x="270" y="210" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="PNWq4bw_2nv1dbnlcLtl-21" value="3.2. Web Services Looks into Trojan for users" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="50" y="140" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="PNWq4bw_2nv1dbnlcLtl-22" value="&lt;br&gt;5. IDP Registers / Looks up user in Azure B2C" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="470" y="150" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="PNWq4bw_2nv1dbnlcLtl-24" value="" style="group" parent="1" vertex="1" connectable="0">
          <mxGeometry x="340" y="200" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="PNWq4bw_2nv1dbnlcLtl-11" value="" style="rounded=0;whiteSpace=wrap;html=1;" parent="PNWq4bw_2nv1dbnlcLtl-24" vertex="1">
          <mxGeometry width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="PNWq4bw_2nv1dbnlcLtl-7" value="IDP Client&lt;br&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="PNWq4bw_2nv1dbnlcLtl-24" vertex="1">
          <mxGeometry x="10" y="10" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="PNWq4bw_2nv1dbnlcLtl-8" value="IDP Employee&lt;br&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="PNWq4bw_2nv1dbnlcLtl-24" vertex="1">
          <mxGeometry x="150" y="10" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="PNWq4bw_2nv1dbnlcLtl-9" value="IDP Franchise&lt;br&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="PNWq4bw_2nv1dbnlcLtl-24" vertex="1">
          <mxGeometry x="300" y="10" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="PNWq4bw_2nv1dbnlcLtl-26" value="1. Portal goes to B2C Azure to AuthN" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="840" y="50" width="200" height="30" as="geometry" />
        </mxCell>
        <mxCell id="PNWq4bw_2nv1dbnlcLtl-27" value="2. User Selects IDP For AuthN&lt;br&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="300" y="100" width="140" height="30" as="geometry" />
        </mxCell>
        <mxCell id="PNWq4bw_2nv1dbnlcLtl-28" value="6. Azure B2C Returns AuthN Token&amp;nbsp;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="780" y="100" width="110" height="30" as="geometry" />
        </mxCell>
        <mxCell id="PNWq4bw_2nv1dbnlcLtl-30" value="8. Returns AuthZ token" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="1020" y="210" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="PNWq4bw_2nv1dbnlcLtl-14" value="Portal API&lt;br&gt;" style="shape=parallelogram;perimeter=parallelogramPerimeter;whiteSpace=wrap;html=1;fixedSize=1;" parent="1" vertex="1">
          <mxGeometry x="830" y="200" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="PNWq4bw_2nv1dbnlcLtl-15" value="Portal&amp;nbsp;&lt;br&gt;" style="rhombus;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="1100" y="130" width="80" height="80" as="geometry" />
        </mxCell>
        <mxCell id="PNWq4bw_2nv1dbnlcLtl-16" value="" style="endArrow=classic;startArrow=classic;html=1;rounded=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="PNWq4bw_2nv1dbnlcLtl-14" target="PNWq4bw_2nv1dbnlcLtl-15" edge="1">
          <mxGeometry x="850" y="180" width="50" height="50" as="geometry">
            <mxPoint x="990" y="250" as="sourcePoint" />
            <mxPoint x="1040" y="200" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="PNWq4bw_2nv1dbnlcLtl-29" value="7.AuthN token sent in." style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="980" y="155" width="60" height="20" as="geometry" />
        </mxCell>
        <mxCell id="Q0eX8DomgLe0p6BozYp--1" value="&lt;br&gt;New Flow&lt;br&gt;Portal user clicks login. They are directed to the user flow inside Azure B2C (tenant based). The Userflow directs the user to our IDP server to authenticate against web services for users stored in trojan db. IDP will ensure a user is created in portal api by calling to portal api. All uesrs will now have a User model in azure db. IDP returns an authN token to B2C. B2C then returns its own AuthN token to our front end. That token is then used to get our AuthZ token from portal. The external user id is inside the B2C AuthN token and that is what is used for getting the AuthZ token.&lt;br&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=default;strokeColor=default;fontColor=default;" parent="1" vertex="1">
          <mxGeometry x="30" y="350" width="485" height="230" as="geometry" />
        </mxCell>
        <mxCell id="Q0eX8DomgLe0p6BozYp--4" value="" style="endArrow=classic;html=1;rounded=0;labelBackgroundColor=default;fontColor=default;strokeColor=default;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="PNWq4bw_2nv1dbnlcLtl-11" target="PNWq4bw_2nv1dbnlcLtl-14" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="780" y="270" as="sourcePoint" />
            <mxPoint x="830" y="220" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Q0eX8DomgLe0p6BozYp--5" value="4. Create User if Needed" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontColor=default;" parent="1" vertex="1">
          <mxGeometry x="780" y="300" width="110" height="30" as="geometry" />
        </mxCell>
        <mxCell id="MNn7BY5Kv6AII41G9M5O-1" value="What&#39;s Set Up.&amp;nbsp;&lt;br&gt;Azure: 3 Tenants With B2C Subscriptions. Each B2C has one App Registration. Each App Registration has a SPA Redirect set to {portalurl}/tokenredirect/{franchise|client|employee}. Each B2C also has a new OpenID Connect Provider added named either WebConnect, Employee Portal, or Client Portal. Client ID: login. Secret isnt needed but its secret in sha256. Scope: openid. Response type: id_token. Reponse mode: form_post. User ID: sub. Display name: email.Each B2C has an API Connector set up. Name is Portal. Endpoint url is {portalapiurl}/api/auth/idp/{franhcise|client|employee}.Authentication Type: Basic. Username&amp;nbsp;34DE5BB7-313A-49D6-ABCC-722AEEAD6A81. Password&amp;nbsp;2F2C2CC3-DC33-4339-9E7F-6DB0E3DF956B. Each B2C has a userflow created. Each slightly vary in name but in Prod we can make them uniform. Each is a Signin signup flow. User attribute are set up depending on the tenant. API connector is attached to Bedore including app claims in token. Our custom Open ID Connect is set up as the only identity provider." style="rounded=0;whiteSpace=wrap;html=1;fontColor=default;strokeColor=default;fillColor=default;" vertex="1" parent="1">
          <mxGeometry x="530" y="350" width="490" height="230" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
